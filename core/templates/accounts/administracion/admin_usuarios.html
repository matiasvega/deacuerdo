{% extends "layouts/base.html" %}
{% load static %}
{% load widget_tweaks %}

{% block title %} Listados {% endblock %}

{% block more-stylesheets %}
    <style>
        .tbl_admin {
            width: 100%;
        }

        .dataTables_length {
            display: none;
        }

        .td_opciones {
            text-align: right;
        }
    </style>
{% endblock %}

{% block main-content %}
    <br>
    <div class="card card-principal">
        <div class="card-header card-header-primary">
            <h4 class="card-title">Usuarios registrados en el sistema</h4>
        </div>
        <div class="card-body">
            <div class="alert alert-success alert-dismissible fade show" role="alert" style="display:none;" id="alerta_operacion">
                <p id="texto_alerta"></p>
                <button type="button" class="close" onclick="$('#alerta_operacion').css('display', 'none');" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form method="get">
                <button class="btn btn-sm btn-accion" type="button" role="button" data-accion="A" data-t_elem="U">
                    <i class="material-icons">add</i> Crear
                </button>
            </form>
            <table class="tbl_admin">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Rol</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for u in filtro_usuarios.qs %}
                        <tr class="paginate" id="row_usuario_{{u.id}}">
                            <td>{{u.username}}</td>
                            <td>{{u.usuarioempresa.get_role_display}}</td>
                            <td class="dropdown td_opciones">
                                <button type="button" class="btn btn-sm btn-info dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
                                    <i class="material-icons">miscellaneous_services</i>
                                </button>
                                <div class="dropdown-menu dropdown-menu-right">
                                    <a href="#" class="dropdown-item btn-accion" data-accion="M" data-t_elem="U" data-id_elem="{{ u.id }}"><i class="material-icons">create</i> Modificar</a>
                                    <a href="#" class="dropdown-item btn-accion" data-accion="B" data-t_elem="U" data-id_elem="{{ u.id }}"><i class="material-icons">clear</i> Eliminar</a>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <br>
    <div class="card card-principal">
        <div class="card-header card-header-primary">
            <h4 class="card-title">Empresas registradas en el sistema</h4>
        </div>
        <div class="card-body">
            <form method="get">
                <button class="btn btn-sm btn-accion" type="button" role="button" data-accion="A" data-t_elem="E">
                    <i class="material-icons">add</i> Crear
                </button>
            </form>
            <table class="tbl_admin">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>CUIT</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for e in filtro_empresas.qs %}
                        <tr class="paginate" id="row_empresa_{{e.id}}">
                            <td>{{e.nombre_fantasia}}</td>
                            <td>{{e.cuit}}</td>
                            <td class="dropdown td_opciones">
                                <button type="button" class="btn btn-sm btn-info dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
                                    <i class="material-icons">miscellaneous_services</i>
                                </button>
                                <div class="dropdown-menu dropdown-menu-right">
                                    <a href="#" class="dropdown-item btn-accion" data-accion="M" data-t_elem="E" data-id_elem="{{ e.id }}"><i class="material-icons">create</i> Modificar</a>
                                    <a href="#" class="dropdown-item btn-accion" data-accion="B" data-t_elem="E" data-id_elem="{{ e.id }}"><i class="material-icons">clear</i> Eliminar</a>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

{% endblock %}

{% block chatbot-content %}{% endblock %}

{% block scripts %}
    <script>
        $(document).ready(function() {
            $('.tbl_admin').DataTable({
                columnDefs: [
                    { orderable: false, targets: -1 }
                ],
                language: {
                            "aria": {
                                "sortAscending": "Activar para ordenar la columna de manera ascendente",
                                "sortDescending": "Activar para ordenar la columna de manera descendente"
                            },
                            "infoThousands": ",",
                            "loadingRecords": "Cargando...",
                            "paginate": {
                                "first": "Primero",
                                "last": "Último",
                                "next": "Siguiente",
                                "previous": "Anterior"
                            },
                            "processing": "Procesando...",
                            "search": "Buscar:",

                            "thousands": ",",
                            "decimal": ".",
                            "emptyTable": "No hay datos disponibles en la tabla",
                            "zeroRecords": "No se encontraron coincidencias",
                            "info": "Mostrando _START_ a _END_ de _TOTAL_ entradas",
                            "infoEmpty": "Mostrando 0 a 0 de 0 entradas",
                            "infoFiltered": "(Filtrado de _MAX_ total de entradas)",
                            "lengthMenu": "Mostrar _MENU_ entradas"
                        }
            })

            $('.btn-accion').click(function () {
                let accion = $(this).data('accion')
                let t_elem = $(this).data('t_elem')
                let id_elem = $(this).data('id_elem')

                if (accion === 'A') {
                    let url = t_elem === 'U' ? "{% url 'cre_usuario' %}" : "{% url 'cre_empresa' %}"
                    window.location.href = url.replace('123', id_elem)
                } else if (accion === 'M') {
                    let url = t_elem === 'U' ? "{% url 'mod_usuario' 123 %}" : "{% url 'mod_empresa' 123 %}"
                    window.location.href = url.replace('123', id_elem)
                } else {
                    let url = t_elem === 'U' ? "{% url 'eliminar_usuario' 123 %}" : "{% url 'eliminar_empresa' 123 %}"

                    Swal.fire({
                        title: '¿Estas seguro?',
                        text: "Esta accion eliminara el elemento",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Eliminar',
                        cancelButtonText: 'Cancelar'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            $.post(url.replace('123', id_elem), {csrfmiddlewaretoken: '{{ csrf_token }}'}, function (data) {
                                if (data['ok']) {
                                    if (t_elem === 'U') {
                                        $("#row_usuario_"+id_elem).remove()
                                    } else {

                                    }
                                }
                            })
                            Swal.fire(
                                'Eliminado',
                                'Se elimino el elemento',
                                'success'
                            ).then(function () {
                                location.reload()
                            })
                        }
                    })
                }
            })
        })
    </script>
{% endblock %}
